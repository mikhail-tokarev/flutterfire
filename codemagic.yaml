workflows:
  e2e-ios:
    max_build_duration: 20
    scripts:
      - name: Install tools
        script: |
          set -e
          flutter config --no-analytics
          flutter pub global activate melos 2.4.0
          flutter pub global activate flutter_plugin_tools
          sudo npm add --global firebase-tools
      - name: Build application
        script: |
          flutter build ios --no-codesign --simulator --debug --target=./integration_test/e2e_test.dart --dart-define=CI=true
      - name: Ensure Firebase Local Emulator Suite
        working_directory: ./.github/workflows/scripts
        script: |
          set -e
          cd functions
          npm ci --no-audit
          cd ..
          firebase emulators:start --only auth,firestore,functions,storage,database --project flutterfire-e2e-tests &
          until curl --output /dev/null --silent --fail http://localhost:8080; do sleep 1; done
      - name: Ensure iPhone simulator
        script: |
          set -e
          xcrun simctl bootstatus "${SIMULATOR?}" -b
          xcrun simctl logverbose "${SIMULATOR?}" enable
      - name: Run E2E tests
        script: |
          flutter test integration_test/e2e_test.dart -d "${SIMULATOR?}" --dart-define=CI=true
    working_directory: tests
    environment:
      flutter: stable
      node: 16
      java: 11
      vars:
        SIMULATOR: "iPhone 11"
    cache:
      cache_paths:
        - $HOME/.cache/firebase/emulators
